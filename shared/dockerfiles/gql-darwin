FROM --platform=$BUILDPLATFORM crazymax/osxcross:15.5-alpine AS osxcross

FROM alpine:3.22.1 as builder
RUN apk --no-cache add \
    clang lld musl-dev cmake make git && \
    rm -rf /var/cache/apk/*
ENV PATH="/osxcross/bin:$PATH"
ENV LD_LIBRARY_PATH="/osxcross/lib:$LD_LIBRARY_PATH"
RUN uname -m | sed 's/^aarch64$/arm64/' > /tmp/arch.txt
WORKDIR /usr/local/app/
COPY cpp/gql/ ./
RUN --mount=type=bind,from=osxcross,source=/osxcross,target=/osxcross \
    CC=$(cat /tmp/arch.txt)-apple-darwin24.5-clang \
    CXX=$(cat /tmp/arch.txt)-apple-darwin24.5-clang++ \
    cmake \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_CXX_FLAGS="-mmacos-version-min=15.0" \
        -DGQL_BUILD_TESTS=OFF \
        -S . \
        -B build && \
    cmake --build build --parallel 4

FROM scratch as scratch
COPY --from=builder /usr/local/app/build/bin/gql /gql
CMD ["/gql"]
